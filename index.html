<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sensor Data</title>
</head>
<body>
  <h1>Latest Readings</h1>
  
  <div id="sensor-IC-CON1">
    <h2>IC#CON1</h2>
    Temperature: <span class="temp">Loading...</span> °C<br />
    Humidity: <span class="hum">Loading...</span> %<br />
    Time: <span class="time">Loading...</span>
  </div>
  
  <div id="sensor-IC-CON2">
    <h2>IC#CON2</h2>
    Temperature: <span class="temp">Loading...</span> °C<br />
    Humidity: <span class="hum">Loading...</span> %<br />
    Time: <span class="time">Loading...</span>
  </div>
  
  <div id="sensor-IC-CON3">
    <h2>IC#CON3</h2>
    Temperature: <span class="temp">Loading...</span> °C<br />
    Humidity: <span class="hum">Loading...</span> %<br />
    Time: <span class="time">Loading...</span>
  </div>

<script>
async function fetchLatestData() {
  const url = "https://bumpy-elite-seahorse.glitch.me/proxy?apptoken=cebe600e-91af-45d7-93c6-c964ad77646a";

  try {
    const response = await fetch(url);
    const json = await response.json();

    console.log("Fetched JSON:", json);

    if (!json.data) throw new Error("Invalid or missing 'data' field in response");

    const sensors = ["IC#CON1", "IC#CON2", "IC#CON3"];

    sensors.forEach(sensorName => {
      // Normalize function to compare sensor names ignoring case and whitespace
      function normalizeName(name) {
        return name.trim().toUpperCase();
      }

      const normalizedSensor = normalizeName(sensorName);

      // Find all entries matching the sensor name (normalized)
      const matchingEntries = json.data.filter(entry => normalizeName(entry.name) === normalizedSensor);

      // Sort by received_at descending to get latest
      const sensorData = matchingEntries.sort((a, b) => new Date(b.received_at) - new Date(a.received_at))[0];

      const container = document.getElementById(`sensor-${sensorName.replace(/#/g, '-')}`);

      if (sensorData && container) {
        container.querySelector(".temp").textContent = sensorData.TempC_SHT.toFixed(1);
        container.querySelector(".hum").textContent = sensorData.Hum_SHT.toFixed(1);
        container.querySelector(".time").textContent = sensorData.received_at;
      } else if (container) {
        container.querySelector(".temp").textContent = "No data";
        container.querySelector(".hum").textContent = "No data";
        container.querySelector(".time").textContent = "No data";
      }
    });
  } catch (error) {
    console.error("Error fetching or processing data:", error);
    ["IC-CON1", "IC-CON2", "IC-CON3"].forEach(id => {
      const container = document.getElementById(`sensor-${id}`);
      if (container) {
        container.querySelector(".temp").textContent = "Error";
        container.querySelector(".hum").textContent = "Error";
        container.querySelector(".time").textContent = "Error";
      }
    });
  }
}

// Run once and then every 30 seconds
fetchLatestData();
setInterval(fetchLatestData, 30000);
</script>


</body>
</html>
